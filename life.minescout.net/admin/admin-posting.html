<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Minescouts Life</title>
    
    <!-- Tailwind CSS for Admin UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #10B981; border-radius: 4px; }
        ::-webkit-scrollbar-track { background-color: #1F2937; }
        
        .container-bg { background-color: #111827; }
        .hidden { display: none !important; }
        
        /* Tab Styles */
        .tab-btn { border-bottom: 2px solid transparent; color: #9CA3AF; }
        .tab-btn:hover { color: #E5E7EB; }
        .tab-btn.active { border-bottom: 2px solid #10B981; color: #10B981; }
        
        /* Request Card Priority Colors */
        .request-item { border-left: 4px solid #374151; transition: all 0.3s ease; }
        .request-item:hover { background-color: #1f2937; }
        
        /* Priority Colors */
        .request-item.HIGH { border-left-color: #EF4444; }
        .request-item.MED { border-left-color: #F59E0B; }
        .request-item.LOW { border-left-color: #10B981; }

        /* READ STATE (Dimmed) */
        .request-item.read { opacity: 0.5; background-color: #111827; border-left-color: #4B5563; }
        .request-item.read:hover { opacity: 1; background-color: #1f2937; }
    </style>
</head>
<body class="container-bg min-h-screen text-gray-300 font-sans flex flex-col">

    <!-- HEADER -->
    <header class="w-full bg-gray-800 p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-bold text-white tracking-wide">Minescout Admin</h1>
                <a href="../index.html" class="text-sm text-green-400 hover:underline">← Back to Site</a>
            </div>
            <div id="user-display" class="hidden text-sm flex items-center gap-4">
                <span id="user-email-display" class="text-gray-400"></span>
                <button id="signOut-btn" class="bg-gray-700 hover:bg-red-600 text-white px-3 py-1 rounded transition">Sign Out</button>
            </div>
        </div>
    </header>

    <div class="max-w-4xl mx-auto w-full mt-8 px-4 mb-12">
        
        <!-- TABS NAVIGATION -->
        <div class="flex border-b border-gray-700 mb-6">
            <button class="tab-btn active px-6 py-3 font-semibold transition" onclick="switchTab('create')">
                Create Content
            </button>
            <button class="tab-btn px-6 py-3 font-semibold transition relative" onclick="switchTab('inbox')">
                Inbox / Requests
                <span id="notification-badge" class="hidden absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
            </button>
        </div>

        <!-- TAB 1: CREATE CONTENT -->
        <div id="tab-create" class="tab-content">
            <div class="bg-gray-900 p-6 rounded-xl border border-gray-700 shadow-xl">
                <h2 class="text-2xl font-bold text-white mb-6">Publish New Content</h2>
                
                <form id="post-form" class="space-y-6">
                    
                    <!-- Content Type Toggle -->
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">What are you posting?</label>
                        <div class="flex gap-4 items-center bg-gray-800 p-1 rounded-lg border border-gray-700">
                            <label class="flex-1 text-center p-2 cursor-pointer rounded transition hover:bg-gray-700 has-[:checked]:bg-green-600 has-[:checked]:text-white">
                                <input type="radio" name="contentType" value="post" class="sr-only" checked onchange="toggleForm('post')">
                                <span class="font-semibold">Article Post</span>
                            </label>
                            <label class="flex-1 text-center p-2 cursor-pointer rounded transition hover:bg-gray-700 has-[:checked]:bg-green-600 has-[:checked]:text-white">
                                <input type="radio" name="contentType" value="announcement" class="sr-only" onchange="toggleForm('announcement')">
                                <span class="font-semibold">Announcement</span>
                            </label>
                        </div>
                    </div>

                    <!-- POST FIELDS -->
                    <div id="post-fields" class="space-y-5">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Title</label>
                            <input type="text" id="post-title" class="w-full p-3 bg-gray-800 border border-gray-700 rounded focus:border-green-500 focus:outline-none transition" placeholder="Enter post title...">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Category</label>
                                <select id="post-category" class="w-full p-3 bg-gray-800 border border-gray-700 rounded focus:border-green-500 focus:outline-none">
                                    <option value="" disabled selected>Select...</option>
                                    <option value="Coding Projects">Coding Projects</option>
                                    <option value="Tech Tips">Tech Tips</option>
                                    <option value="Updates">Updates</option>
                                    <option value="Puppy Life">Puppy Life</option>
                                    <option value="Minecraft Server">Minecraft Server</option>
                                    <option value="General">General</option>
                                    <option value="BETA">Beta Software</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">Link URL</label>
                                <input type="text" id="post-link" class="w-full p-3 bg-gray-800 border border-gray-700 rounded focus:border-green-500 focus:outline-none" placeholder="posts/tech/filename.html">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Image URL (Optional)</label>
                            <input type="text" id="image-link" class="w-full p-3 bg-gray-800 border border-gray-700 rounded focus:border-green-500 focus:outline-none" placeholder="../assests/images/...">
                        </div>

                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Summary</label>
                            <textarea id="post-content" rows="4" class="w-full p-3 bg-gray-800 border border-gray-700 rounded focus:border-green-500 focus:outline-none" placeholder="Short description for the card..."></textarea>
                        </div>

                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Custom Date (Optional)</label>
                            <div class="flex gap-2">
                                <input type="date" id="post-date" class="bg-gray-800 border border-gray-700 rounded p-2 text-white">
                                <input type="time" id="post-time" class="bg-gray-800 border border-gray-700 rounded p-2 text-white">
                            </div>
                        </div>
                    </div>

                    <!-- ANNOUNCEMENT FIELDS -->
                    <div id="announcement-fields" class="space-y-5 hidden">
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Announcement Title</label>
                            <input type="text" id="announcement-title" class="w-full p-3 bg-gray-800 border border-gray-700 rounded focus:border-green-500 focus:outline-none" placeholder="Bold header text...">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Message</label>
                            <textarea id="announcement-text" rows="3" class="w-full p-3 bg-gray-800 border border-gray-700 rounded focus:border-green-500 focus:outline-none" placeholder="The main text body..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Signed By</label>
                            <input type="text" id="announcement-from" class="w-full p-3 bg-gray-800 border border-gray-700 rounded focus:border-green-500 focus:outline-none" placeholder="e.g. Minescout Team">
                        </div>
                    </div>

                    <button type="submit" id="publish-btn" class="w-full py-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg transition duration-200">
                        Publish Now
                    </button>
                </form>
                
                <div id="status-message" class="mt-4 p-3 rounded text-center hidden font-bold"></div>
            </div>
        </div>

        <!-- TAB 2: INBOX (FEATURE REQUESTS) -->
        <div id="tab-inbox" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Feature Requests</h2>
                <!-- Filter buttons could go here in future -->
            </div>
            
            <div id="requests-list" class="space-y-4">
                <p class="text-center text-gray-500 py-10">Loading requests...</p>
            </div>
        </div>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { db, auth } from "../assests/js/firebase-config.js";
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { ref, push, serverTimestamp, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        let userId = null;

        // --- AUTH LOGIC ---
        onAuthStateChanged(auth, user => {
            if(user) {
                userId = user.uid;
                document.getElementById('user-email-display').textContent = user.email;
                document.getElementById('user-display').classList.remove('hidden');
                loadRequests(); // Pre-load inbox data
            } else {
                // Kick out if not logged in
                window.location.href = "../login.html";
            }
        });

        document.getElementById('signOut-btn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = "../index.html");
        });

        // --- UI FUNCTIONS (Global for onclick) ---
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        };

        window.toggleForm = (type) => {
             if (type === 'post') {
                document.getElementById('post-fields').classList.remove('hidden');
                document.getElementById('announcement-fields').classList.add('hidden');
            } else {
                document.getElementById('post-fields').classList.add('hidden');
                document.getElementById('announcement-fields').classList.remove('hidden');
            }
        };

        window.deleteRequest = (id) => {
            if(confirm("Permanently delete this request?")) {
                remove(ref(db, `feature_requests/${id}`));
            }
        };

        // NEW: Function to Toggle Read/Unread Status
        window.toggleStatus = (id, currentStatus) => {
            const newStatus = currentStatus === 'new' ? 'read' : 'new';
            update(ref(db, `feature_requests/${id}`), {
                status: newStatus
            });
        };

        // --- INBOX LOGIC ---
        function loadRequests() {
            const list = document.getElementById('requests-list');
            const badge = document.getElementById('notification-badge');
            
            onValue(ref(db, 'feature_requests'), (snapshot) => {
                list.innerHTML = '';
                const data = snapshot.val();
                
                if(!data) {
                    list.innerHTML = '<div class="text-center text-gray-500 py-10 bg-gray-900 rounded-lg">No pending requests.</div>';
                    badge.classList.add('hidden');
                    return;
                }

                let unreadCount = 0;
                const keys = Object.keys(data).reverse(); // Newest first

                keys.forEach(key => {
                    const req = data[key];
                    const isRead = req.status === 'read';
                    if(!isRead) unreadCount++;
                    
                    const date = req.timestamp ? new Date(req.timestamp).toLocaleDateString() : 'Unknown Date';
                    
                    const div = document.createElement('div');
                    // Apply 'read' class if status is read (dims opacity)
                    div.className = `request-item ${req.priority} ${isRead ? 'read' : ''} bg-gray-900 p-4 rounded-lg shadow-md flex justify-between items-start`;
                    
                    div.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs font-bold px-2 py-0.5 rounded bg-gray-800 border border-gray-600 text-gray-300">
                                    ${req.priority}
                                </span>
                                <h3 class="font-bold text-white text-lg">
                                    ${escapeHtml(req.subject)}
                                    ${!isRead ? '<span class="ml-2 inline-block w-2 h-2 bg-green-500 rounded-full"></span>' : ''}
                                </h3>
                            </div>
                            <p class="text-xs text-gray-500 mb-2">From: ${escapeHtml(req.sender)} • ${date}</p>
                            <p class="text-gray-300 whitespace-pre-wrap text-sm">${escapeHtml(req.description)}</p>
                        </div>
                        <div class="ml-4 flex flex-col gap-2">
                             <button class="text-xs px-3 py-1 rounded border border-gray-600 hover:bg-gray-700 transition text-gray-300" onclick="toggleStatus('${key}', '${req.status}')">
                                ${isRead ? 'Mark Unread' : 'Mark Read'}
                             </button>
                             <button class="text-xs bg-red-900/50 text-red-200 px-3 py-1 rounded hover:bg-red-900 transition border border-red-800" onclick="deleteRequest('${key}')">
                                Delete
                             </button>
                        </div>
                    `;
                    list.appendChild(div);
                });

                // Update Badge
                if(unreadCount > 0) {
                    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            });
        }

        // --- PUBLISH LOGIC (Same as before) ---
        const postForm = document.getElementById('post-form');
        const statusMessage = document.getElementById('status-message');
        const publishBtn = document.getElementById('publish-btn');

        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = document.querySelector('input[name="contentType"]:checked').value;
            
            publishBtn.disabled = true;
            publishBtn.textContent = "Publishing...";
            publishBtn.classList.add('opacity-50');

            try {
                if (type === 'post') {
                    const title = document.getElementById('post-title').value.trim();
                    const category = document.getElementById('post-category').value;
                    const summary = document.getElementById('post-content').value.trim();
                    const linkUrl = document.getElementById('post-link').value.trim();
                    const imageUrl = document.getElementById('image-link').value.trim();
                    
                    const dateInput = document.getElementById('post-date').value;
                    const timeInput = document.getElementById('post-time').value;
                    let timestamp = serverTimestamp();
                    
                    if (dateInput) {
                        const timeStr = timeInput || '12:00:00';
                        timestamp = new Date(`${dateInput}T${timeStr}`).getTime();
                    }

                    if(!title || !linkUrl) throw new Error("Title and Link are required");

                    await push(ref(db, 'content'), {
                        type: 'post', title, category, summary, linkUrl, imageUrl,
                        timestamp: timestamp, authorId: userId
                    });

                } else {
                    const title = document.getElementById('announcement-title').value.trim();
                    const text = document.getElementById('announcement-text').value.trim();
                    const from = document.getElementById('announcement-from').value.trim();

                    if(!title || !text) throw new Error("Title and Message are required");

                    await push(ref(db, 'content'), {
                        type: 'announcement', title, text, from,
                        timestamp: serverTimestamp(), authorId: userId
                    });
                }

                showMessage("Published Successfully!", false);
                postForm.reset();
                document.querySelector('input[value="post"]').checked = true;
                toggleForm('post');

            } catch (error) {
                console.error(error);
                showMessage(error.message, true);
            } finally {
                publishBtn.disabled = false;
                publishBtn.textContent = "Publish Now";
                publishBtn.classList.remove('opacity-50');
            }
        });

        function showMessage(msg, isError) {
            statusMessage.textContent = msg;
            statusMessage.classList.remove('hidden', 'bg-green-900', 'text-green-200', 'bg-red-900', 'text-red-200');
            
            if(isError) {
                statusMessage.classList.add('bg-red-900', 'text-red-200');
            } else {
                statusMessage.classList.add('bg-green-900', 'text-green-200');
            }
            statusMessage.classList.remove('hidden');
            setTimeout(() => statusMessage.classList.add('hidden'), 4000);
        }

        function escapeHtml(text) {
            if(!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }
    </script>
</body>
</html>