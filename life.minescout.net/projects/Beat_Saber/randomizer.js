// --- Beat Saber Song Data (Comprehensive - Updated with OCR content) ---
const beatSaberData = {
    // --- PASTE THE ENTIRE HUGE beatSaberData OBJECT HERE ---
    // (Omitted for brevity - MUST include the full data from your original post)
    "OST Vol. 1": { "$100 Bills": { Easy: 1.13, Normal: 1.68, Hard: 2.48, Expert: 3.47, "Expert+": 4.19 }, /* ... rest of OST Vol 1 ... */ },
    "OST Vol. 2": { "Be There For You (feat. Kinnie Lane)": { Easy: 1.38, Normal: 2.07, Hard: 2.91, Expert: 3.93, "Expert+": 5.04 }, /* ... */ },
    "OST Vol. 3": { "Origins (feat. Charlotte Haining)": { Easy: 1.51, Normal: 2.2, Hard: 3.19, Expert: 4.32, "Expert+": 5.66 }, /* ... */ },
    "OST Vol. 4": { "Into The Dream (feat. Jakub Tirco)": { Easy: 1.63, Normal: 2.32, Hard: 3.27, Expert: 4.28, "Expert+": 5.41 }, /* ... */ },
    "OST Vol. 5": { "EXIT This Earth's Atomosphere": { Easy: 1.61, Normal: 2.29, Hard: 3.25, Expert: 4.42, "Expert+": 5.7 }, /* ... */ },
    "OST Vol. 6": { "Heavy Weight": { Easy: 1.99, Normal: 2.81, Hard: 4.03, Expert: 5.55, "Expert+": 7.25 }, /* ... */ },
    "OST Vol. 7": { "The Master": { Easy: 1.7, Normal: 2.5, Hard: 3.6, Expert: 4.9, "Expert+": 6.3 }, /* ... */ },
    Extras: { FitBeat: { Easy: 1.27, Normal: 1.86, Hard: 2.69, Expert: 3.83, "Expert+": 4.9 }, /* ... */ },
    "Camellia Music Pack": { "EXIT This Earth's Atomosphere": { Easy: 1.61, Normal: 2.29, Hard: 3.25, Expert: 4.42, "Expert+": 5.7 }, /* ... */ },
    "Monstercat Music Pack Vol. 1": { Boundless: { Easy: 1.31, Normal: 1.81, Hard: 2.55, Expert: 3.43, "Expert+": 4.31 }, /* ... */ },
    "Imagine Dragons Music Pack": { Bones: { Easy: 1.25, Normal: 1.8, Hard: 2.6, Expert: 3.55, "Expert+": 4.6 }, /* ... */ },
    "Panic! At The Disco Music Pack": { "Hey Look Ma, I Made It": { Easy: 1.3, Normal: 1.9, Hard: 2.75, Expert: 3.75, "Expert+": 4.85 }, /* ... */ },
    "Rocket League x Monstercat Music Pack": { Glide: { Easy: 1.22, Normal: 1.75, Hard: 2.5, Expert: 3.39, "Expert+": 4.35 }, /* ... */ },
    "Green Day Music Pack": { "American Idiot": { Easy: 1.54, Normal: 2.27, Hard: 3.25, Expert: 4.4, "Expert+": 5.71 }, /* ... */ },
    "Timbaland Music Pack": { "Dumb Thingz": { Easy: 1.13, Normal: 1.65, Hard: 2.39, Expert: 3.28, "Expert+": 4.22 }, /* ... */ },
    "Linkin Park Music Pack": { "Bleed It Out": { Easy: 1.45, Normal: 2.11, Hard: 3.06, Expert: 4.18, "Expert+": 5.4 }, /* ... */ },
    "BTS Music Pack": { "Blood Sweat & Tears": { Easy: 1.03, Normal: 1.53, Hard: 2.24, Expert: 3.08, "Expert+": 3.97 }, /* ... */ },
    "Interscope Mixtape": { "Counting Stars": { Easy: 1.31, Normal: 1.91, Hard: 2.76, Expert: 3.78, "Expert+": 4.88 }, /* ... */ },
    "Skrillex Music Pack": { "Bangarang feat. Sirah": { Easy: 1.64, Normal: 2.4, Hard: 3.48, Expert: 4.77, "Expert+": 6.16 }, /* ... */ },
    "Billie Eilish Music Pack": { "all the good girls go to hell": { Easy: 1.27, Normal: 1.87, Hard: 2.71, Expert: 3.72, "Expert+": 4.8 }, /* ... */ },
    "Lady Gaga Music Pack": { Alejandro: { Easy: 1.07, Normal: 1.57, Hard: 2.28, Expert: 3.13, "Expert+": 4.04 }, /* ... */ },
    "Fall Out Boy Music Pack": { Centuries: { Easy: 1.17, Normal: 1.72, Hard: 2.5, Expert: 3.44, "Expert+": 4.45 }, /* ... */ },
    "Electronic Mixtape": { Alone: { Easy: 1.49, Normal: 2.19, Hard: 3.18, Expert: 4.37, "Expert+": 5.64 }, /* ... */ },
    "Lizzo Music Pack": { "Cuz I Love You": { Easy: 1.04, Normal: 1.52, Hard: 2.21, Expert: 3.04, "Expert+": 3.93 }, /* ... */ },
    "The Weeknd Music Pack": { "Die For You": { Easy: 1.1, Normal: 1.6, Hard: 2.3, Expert: 3.1, "Expert+": 4.0 }, /* ... */ },
    "Rock Mixtape": { "Born To Be Wild": { Easy: 1.36, Normal: 2.0, Hard: 2.9, Expert: 3.99, "Expert+": 5.15 }, /* ... */ },
    "Queen Music Pack": { "Another One Bites the Dust": { Easy: 1.18, Normal: 1.73, Hard: 2.51, Expert: 3.45, "Expert+": 4.46 }, /* ... */ },
    "Linkin Park x Mike Shinoda Pack": { "Already Over": { Easy: 1.41, Normal: 2.07, Hard: 3.0, Expert: 4.13, "Expert+": 5.33 }, /* ... */ },
    "The Rolling Stones Music Pack": { Angry: { Easy: 1.37, Normal: 2.01, Hard: 2.92, Expert: 4.01, "Expert+": 5.18 }, /* ... */ },
    "Daft Punk Music Pack": { "Around the World / Harder Better Faster Stronger (Live 2007)": { Easy: 1.31, Normal: 1.92, Hard: 2.8, Expert: 3.84, "Expert+": 4.96 }, /* ... */ },
    "Hip Hop Mixtape": { "All Eyez On Me (feat. Big Syke)": { Easy: 1.25, Normal: 1.85, Hard: 2.7, Expert: 3.7, "Expert+": 4.8 }, /* ... */ },
    "Shock Drops": { Houdini: { Easy: 1.6, Normal: 2.3, Hard: 3.3, Expert: 4.5, "Expert+": 5.9 }, /* ... */ },
    "Monstercat Mixtape 2": { Accelerate: { Easy: 1.75, Normal: 2.55, Hard: 3.7, Expert: 5.0, "Expert+": 6.5 }, /* ... */ }
};

// --- Difficulty Order Mapping (Name to Number) ---
const difficultyOrder = {
  Easy: 1,
  Normal: 2,
  Hard: 3,
  Expert: 4,
  "Expert+": 5
};
const MIN_DIFFICULTY_NUM = 1; // Corresponds to Easy
const MAX_DIFFICULTY_NUM = 5; // Corresponds to Expert+

// --- DOM Elements ---
const rollButton = document.getElementById("rollButton");
const settingsToggleBtn = document.getElementById("settingsToggleBtn");
const settingsPanel = document.getElementById("settingsPanel");
const packCheckboxesContainer = document.getElementById("packCheckboxes");
const selectAllPacksBtn = document.getElementById("selectAllPacks"); // Updated ID
const deselectAllPacksBtn = document.getElementById("deselectAllPacks"); // Updated ID
const minDifficultySelect = document.getElementById("minDifficulty"); // Updated ID
const maxDifficultySelect = document.getElementById("maxDifficulty"); // Updated ID
const minNpsInput = document.getElementById("minNPS"); // Updated ID
const maxNpsInput = document.getElementById("maxNPS"); // Updated ID
const refreshButton = document.getElementById("refreshButton");

// Result Display Elements
const rolledSongEl = document.getElementById("rolledSong"); // Updated ID
const rolledDifficultyEl = document.getElementById("rolledDifficulty"); // Updated ID
const rolledNpsEl = document.getElementById("rolledNPS"); // Updated ID


// --- Default Packs to Check ---
const defaultCheckedPacks = [
  "OST Vol. 1", "OST Vol. 2", "OST Vol. 3", "OST Vol. 4", "OST Vol. 5",
  "OST Vol. 6", "OST Vol. 7", "Extras", "Camellia Music Pack"
];

// --- Roll History ---
let rollHistory = [];
const HISTORY_SIZE = 5; // Keep track of the last 5 rolls to avoid repeats

// --- Pack Order Definition (Based on OCR Scan / Desired Order) ---
const packOrder = [
  "OST Vol. 1", "OST Vol. 2", "OST Vol. 3", "OST Vol. 4", "OST Vol. 5",
  "OST Vol. 6", "OST Vol. 7", "Extras", "Camellia Music Pack",
  "Monstercat Music Pack Vol. 1", "Imagine Dragons Music Pack",
  "Panic! At The Disco Music Pack", "Rocket League x Monstercat Music Pack",
  "Green Day Music Pack", "Timbaland Music Pack", "Linkin Park Music Pack",
  "BTS Music Pack", "Interscope Mixtape", "Skrillex Music Pack",
  "Billie Eilish Music Pack", "Lady Gaga Music Pack", "Fall Out Boy Music Pack",
  "Electronic Mixtape", "Lizzo Music Pack",
  "The Weeknd Music Pack", "Rock Mixtape", "Queen Music Pack",
  "Linkin Park x Mike Shinoda Pack", "The Rolling Stones Music Pack",
  "Daft Punk Music Pack", "Hip Hop Mixtape", "Shock Drops",
  "Monstercat Mixtape 2"
];


// --- Populate Pack Checkboxes ---
function populatePackCheckboxes() {
  packCheckboxesContainer.innerHTML = ""; // Clear previous checkboxes

  packOrder.forEach((packName) => {
    if (beatSaberData[packName]) { // Check if pack exists in data
      const div = document.createElement("div"); // Wrap checkbox and label
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.id = `pack_${packName.replace(/[^\w]+/g, "_")}`; // Create a safer ID
      checkbox.value = packName;
      checkbox.classList.add("pack-checkbox"); // Add class for select all/none

      if (defaultCheckedPacks.includes(packName)) {
        checkbox.checked = true;
      }

      const label = document.createElement("label");
      label.htmlFor = checkbox.id;
      label.textContent = packName;

      div.appendChild(checkbox);
      div.appendChild(label);
      packCheckboxesContainer.appendChild(div);
    } else {
      console.warn(
        `Pack "${packName}" defined in packOrder but not found in beatSaberData.`
      );
    }
  });
}

// --- Settings Toggle ---
function toggleSettings() {
  // Toggle the 'visible' class which controls max-height and visibility via CSS
  settingsPanel.classList.toggle("visible");
}

// --- Pack Checkbox Controls ---
function selectAllPacks(state) {
  const checkboxes = packCheckboxesContainer.querySelectorAll(".pack-checkbox");
  checkboxes.forEach((cb) => (cb.checked = state));
}

// --- Event Listeners ---
settingsToggleBtn.addEventListener("click", toggleSettings);
rollButton.addEventListener("click", rollSong);
selectAllPacksBtn.addEventListener("click", () => selectAllPacks(true));
deselectAllPacksBtn.addEventListener("click", () => selectAllPacks(false));
refreshButton.addEventListener("click", () => {
  // Reset to initial state rather than full reload for smoother experience
  // Reset checkboxes
   populatePackCheckboxes();
   // Reset dropdowns/inputs
   minDifficultySelect.value = "0"; // Assuming 'Any' is value 0 for min
   maxDifficultySelect.value = "5"; // Assuming 'Any' is value 5 for max
   minNpsInput.value = "";
   maxNpsInput.value = "";
   // Reset result display
   displayResult("", "", "", "", true); // Call display with reset flag
   // Clear history
   rollHistory = [];
});

// --- Core Functions ---
function getRandomElement(arr) {
  if (!arr || arr.length === 0) return null;
  const randomIndex = Math.floor(Math.random() * arr.length);
  return arr[randomIndex];
}

function rollSong() {
  // 1. Get Settings
  const selectedPackNames = Array.from(
    packCheckboxesContainer.querySelectorAll(".pack-checkbox:checked")
  ).map((cb) => cb.value);

  // Parse numerical difficulty values from dropdowns
  // Treat Min 'Any' (value 0) as MIN_DIFFICULTY_NUM (1)
  let minVal = parseInt(minDifficultySelect.value);
  let maxVal = parseInt(maxDifficultySelect.value);

  let selectedMinDiffNum = (minVal === 0) ? MIN_DIFFICULTY_NUM : minVal;
  let selectedMaxDiffNum = maxVal; // Max 'Any' is value 5, which is MAX_DIFFICULTY_NUM

  // Ensure min isn't logically greater than max selected
  const finalMinDiffNum = Math.min(selectedMinDiffNum, selectedMaxDiffNum);
  const finalMaxDiffNum = Math.max(selectedMinDiffNum, selectedMaxDiffNum);


  // Get NPS range, defaulting to 0 and Infinity if invalid/empty
  const minNps = parseFloat(minNpsInput.value) || 0;
  const maxNps = parseFloat(maxNpsInput.value) || Infinity;

  // 2. Determine available packs (use selected or all if none selected)
  let availablePackNames = selectedPackNames.length > 0
      ? selectedPackNames
      : packOrder.filter(p => beatSaberData[p]); // Filter packOrder to ensure they exist in data

  if (availablePackNames.length === 0) {
    displayError("No packs available to roll from based on current selection or data.");
    return;
  }

  let attempts = 0;
  const maxAttempts = availablePackNames.length * 75; // Adjusted max attempts

  while (attempts < maxAttempts) {
    attempts++;

    // 3. Select Pack from the available list
    const selectedPackName = getRandomElement(availablePackNames);
    if (!beatSaberData[selectedPackName]) continue; // Safety check
    const songsInPack = beatSaberData[selectedPackName];
    const songTitles = Object.keys(songsInPack);
    if (songTitles.length === 0) continue; // Skip empty packs

    // 4. Select Song
    const selectedSongTitle = getRandomElement(songTitles);
    if (!selectedSongTitle || !songsInPack[selectedSongTitle]) continue;
    const difficultiesForSong = songsInPack[selectedSongTitle];

    // 5. Filter available difficulties for THIS song based on settings
     const possibleDifficulties = Object.keys(difficultiesForSong).filter(diffName => {
        const diffNum = difficultyOrder[diffName]; // Get the number (1-5) for the name
        if (!diffNum) return false; // Unknown difficulty name in data

        const nps = difficultiesForSong[diffName];
        if (nps === undefined) return false; // NPS data missing

        // Check difficulty number and NPS range against selected values
        return diffNum >= finalMinDiffNum && diffNum <= finalMaxDiffNum && nps >= minNps && nps <= maxNps;
    });

    // If no difficulties match criteria for this song, try another song/pack
    if (possibleDifficulties.length === 0) {
        continue;
    }

    // 6. Select a VALID Difficulty Name from the filtered list
    const selectedDifficultyName = getRandomElement(possibleDifficulties);
    const npsValue = difficultiesForSong[selectedDifficultyName]; // We know this exists now

    // --- 7. Check Roll History ---
    // Use Pack+Song+Difficulty Name as the key
    const historyKey = `${selectedPackName}|${selectedSongTitle}|${selectedDifficultyName}`;
    if (rollHistory.includes(historyKey)) {
      // Relax check if nearing max attempts to prevent infinite loops in small pools
      if (attempts < maxAttempts * 0.9) {
        continue; // Reroll if the specific map is in recent history
      } else {
         console.log("High attempts, ignoring history for:", historyKey);
      }
    }

    // --- If all checks passed ---

    // 8. Update History
    rollHistory.unshift(historyKey); // Add the unique key to the front
    if (rollHistory.length > HISTORY_SIZE) {
      rollHistory.pop(); // Remove the oldest entry if history is full
    }

    // 9. Display Result
    displayResult(
      selectedPackName,
      selectedSongTitle,
      selectedDifficultyName,
      npsValue
    );
    return; // Exit successfully
  }

  // If loop finishes without finding a match
  displayError(
    `No songs match your criteria (Packs: ${selectedPackNames.length > 0 ? selectedPackNames.length : 'All'}, Difficulty: ${finalMinDiffNum}-${finalMaxDiffNum}, NPS: ${minNps === 0 ? 'any' : minNps.toFixed(1)}-${maxNps === Infinity ? 'any' : maxNps.toFixed(1)}, avoiding last ${HISTORY_SIZE} rolls) after ${maxAttempts} attempts. Try loosening filters or selecting more packs.`
  );
}


// Updated display function for the new HTML structure
function displayResult(pack, song, diff, nps, isReset = false) {
    if (isReset) {
         rolledSongEl.textContent = "Press 'Roll Song' to get a random track!";
         rolledDifficultyEl.textContent = "";
         rolledNpsEl.textContent = "";
         return;
    }
    rolledSongEl.textContent = `${song} (Pack: ${pack})`;
    rolledDifficultyEl.textContent = `Difficulty: ${diff}`;
    rolledNpsEl.textContent = `NPS: ${nps.toFixed(2)}`; // Format NPS
}

// Updated error display function
function displayError(message) {
  rolledSongEl.textContent = message; // Display error in the main result line
  rolledDifficultyEl.textContent = ""; // Clear other lines
  rolledNpsEl.textContent = "";
  console.error(message);
}

// --- Initial Setup ---
populatePackCheckboxes(); // Populate checkboxes on page load
// Settings panel starts hidden via CSS by default